<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:DevUtilities.ViewModels"
             xmlns:i="using:Avalonia.Xaml.Interactivity"
             xmlns:ia="using:Avalonia.Xaml.Interactions.Core"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="DevUtilities.Views.CronExpressionView"
             x:DataType="vm:CronExpressionViewModel">
  <ScrollViewer VerticalAlignment="Stretch" HorizontalAlignment="Stretch" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
    <StackPanel Margin="20" Spacing="20">
      <!-- 标题 -->
      <SelectableTextBlock Text="Cron表达式生成器" 
                 FontSize="24" 
                 FontWeight="Bold" 
                 HorizontalAlignment="Center"/>

      <!-- 错误信息 -->
      <Border Background="#FFEBEE" CornerRadius="4" Padding="12" 
              IsVisible="{Binding !IsValidExpression}">
        <SelectableTextBlock Text="{Binding ValidationMessage}" 
                   Foreground="#C62828" 
                   TextWrapping="Wrap"/>
      </Border>

      <!-- Cron Expression Input -->
      <Border Background="White" CornerRadius="8" Padding="16" BorderBrush="#E0E0E0" BorderThickness="1">
        <StackPanel Spacing="16">
          <SelectableTextBlock Text="Cron表达式" FontWeight="Bold" FontSize="16"/>
          
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*"/>
              <ColumnDefinition Width="Auto"/>
              <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <TextBox Grid.Column="0" 
                     Text="{Binding CronExpression}" 
                     FontFamily="Consolas" 
                     FontSize="14"
                     Watermark="输入Cron表达式，例如：0 0 12 * * ?"/>
            
            <Button Grid.Column="1" 
                    Content="验证" 
                    Command="{Binding ParseExpressionCommand}"
                    Margin="8,0,0,0"/>
            
            <Button Grid.Column="2" 
                    Content="清空" 
                    Command="{Binding ClearCommand}"
                    Margin="8,0,0,0"/>
          </Grid>

          <!-- 表达式描述 -->
          <Border Background="#F5F5F5" CornerRadius="4" Padding="12"
                  IsVisible="{Binding IsValidExpression}">
            <StackPanel Spacing="8">
              <SelectableTextBlock Text="表达式含义：" FontWeight="SemiBold"/>
              <SelectableTextBlock Text="{Binding Description}" 
                         TextWrapping="Wrap"
                         FontStyle="Italic"/>
            </StackPanel>
          </Border>
        </StackPanel>
      </Border>

      <!-- 预设表达式 -->
      <Border Background="White" CornerRadius="8" Padding="16" BorderBrush="#E0E0E0" BorderThickness="1">
        <StackPanel Spacing="16">
          <SelectableTextBlock Text="常用表达式" FontWeight="Bold" FontSize="16"/>
          
          <ItemsControl ItemsSource="{Binding PresetExpressions}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <WrapPanel Orientation="Horizontal"/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border Background="#F8F9FA" 
                        CornerRadius="4" 
                        Padding="12,8" 
                        Margin="4"
                        BorderBrush="#DEE2E6" 
                        BorderThickness="1"
                        Cursor="Hand">
                  <Border.Styles>
                    <Style Selector="Border:pointerover">
                      <Setter Property="Background" Value="#E9ECEF"/>
                    </Style>
                  </Border.Styles>
                  <StackPanel Spacing="4">
                    <SelectableTextBlock Text="{Binding Key}" 
                               FontWeight="SemiBold" 
                               FontSize="12"/>
                    <SelectableTextBlock Text="{Binding Value}" 
                               FontFamily="Consolas" 
                               FontSize="11" 
                               Foreground="#6C757D"/>
                  </StackPanel>
                  <i:Interaction.Behaviors>
                    <ia:EventTriggerBehavior EventName="Tapped">
                      <ia:InvokeCommandAction Command="{Binding $parent[UserControl].DataContext.UsePresetCommand}" 
                                           CommandParameter="{Binding Value}"/>
                    </ia:EventTriggerBehavior>
                  </i:Interaction.Behaviors>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </StackPanel>
      </Border>

      <!-- 字段构建器 -->
      <Border Background="White" CornerRadius="8" Padding="16" BorderBrush="#E0E0E0" BorderThickness="1">
        <StackPanel Spacing="16">
          <SelectableTextBlock Text="字段构建器" FontWeight="Bold" FontSize="16"/>
          
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*"/>
              <ColumnDefinition Width="*"/>
              <ColumnDefinition Width="*"/>
              <ColumnDefinition Width="*"/>
              <ColumnDefinition Width="*"/>
              <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <!-- Headers -->
            <SelectableTextBlock Grid.Row="0" Grid.Column="0" Text="秒" HorizontalAlignment="Center" FontWeight="Bold"/>
            <SelectableTextBlock Grid.Row="0" Grid.Column="1" Text="分" HorizontalAlignment="Center" FontWeight="Bold"/>
            <SelectableTextBlock Grid.Row="0" Grid.Column="2" Text="时" HorizontalAlignment="Center" FontWeight="Bold"/>
            <SelectableTextBlock Grid.Row="0" Grid.Column="3" Text="日" HorizontalAlignment="Center" FontWeight="Bold"/>
            <SelectableTextBlock Grid.Row="0" Grid.Column="4" Text="月" HorizontalAlignment="Center" FontWeight="Bold"/>
            <SelectableTextBlock Grid.Row="0" Grid.Column="5" Text="周" HorizontalAlignment="Center" FontWeight="Bold"/>
            
            <!-- Dropdowns - 使用AutoCompleteBox实现可编辑功能 -->
            <AutoCompleteBox Grid.Row="1" Grid.Column="0" 
                             ItemsSource="{Binding SecondOptions}"
                             Text="{Binding SelectedSecond, Mode=TwoWay}"
                             IsTextCompletionEnabled="True"
                             FilterMode="Contains"
                             Margin="4"/>
            <AutoCompleteBox Grid.Row="1" Grid.Column="1" 
                             ItemsSource="{Binding MinuteOptions}"
                             Text="{Binding SelectedMinute, Mode=TwoWay}"
                             IsTextCompletionEnabled="True"
                             FilterMode="Contains"
                             Margin="4"/>
            <AutoCompleteBox Grid.Row="1" Grid.Column="2" 
                             ItemsSource="{Binding HourOptions}"
                             Text="{Binding SelectedHour, Mode=TwoWay}"
                             IsTextCompletionEnabled="True"
                             FilterMode="Contains"
                             Margin="4"/>
            <AutoCompleteBox Grid.Row="1" Grid.Column="3" 
                             ItemsSource="{Binding DayOptions}"
                             Text="{Binding SelectedDay, Mode=TwoWay}"
                             IsTextCompletionEnabled="True"
                             FilterMode="Contains"
                             Margin="4"/>
            <AutoCompleteBox Grid.Row="1" Grid.Column="4" 
                             ItemsSource="{Binding MonthOptions}"
                             Text="{Binding SelectedMonth, Mode=TwoWay}"
                             IsTextCompletionEnabled="True"
                             FilterMode="Contains"
                             Margin="4"/>
            <AutoCompleteBox Grid.Row="1" Grid.Column="5" 
                             ItemsSource="{Binding WeekOptions}"
                             Text="{Binding SelectedWeek, Mode=TwoWay}"
                             IsTextCompletionEnabled="True"
                             FilterMode="Contains"
                             Margin="4"/>
          </Grid>
          
          <Button Content="生成表达式" 
                  Command="{Binding GenerateExpressionCommand}"
                  HorizontalAlignment="Center"/>
        </StackPanel>
      </Border>

      <!-- 下次执行时间 -->
      <Border Background="White" CornerRadius="8" Padding="16" BorderBrush="#E0E0E0" BorderThickness="1"
              IsVisible="{Binding IsValidExpression}">
        <StackPanel Spacing="12">
          <SelectableTextBlock Text="下次执行时间" FontWeight="Bold" FontSize="16"/>
          
          <ScrollViewer MaxHeight="200" VerticalScrollBarVisibility="Auto">
            <SelectableTextBlock Text="{Binding NextExecutions}" 
                       FontFamily="Consolas" 
                       FontSize="12"
                       TextWrapping="Wrap"/>
          </ScrollViewer>
          
          <Button Content="刷新执行时间" 
                  Command="{Binding RefreshExecutionsCommand}"
                  Classes="accent"
                  Margin="0,0,10,0"
                  HorizontalAlignment="Left"/>
        </StackPanel>
      </Border>

      <!-- 使用说明 -->
      <Expander Header="使用说明" IsExpanded="False">
        <StackPanel Spacing="12" Margin="10">
          <SelectableTextBlock Text="Cron表达式格式" FontWeight="SemiBold"/>
          <Border Background="#F8F9FA" 
                  CornerRadius="4" 
                  Padding="8">
            <SelectableTextBlock Text="格式：秒 分 时 日 月 周" 
                       FontFamily="Consolas"/>
          </Border>
          
          <SelectableTextBlock Text="字段说明" FontWeight="SemiBold" Margin="0,10,0,0"/>
          <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" 
                ColumnDefinitions="60,*" 
                Margin="10,0">
            <SelectableTextBlock Grid.Row="0" Grid.Column="0" Text="秒" FontWeight="SemiBold"/>
            <SelectableTextBlock Grid.Row="0" Grid.Column="1" Text="0-59的整数"/>
            <SelectableTextBlock Grid.Row="1" Grid.Column="0" Text="分" FontWeight="SemiBold"/>
            <SelectableTextBlock Grid.Row="1" Grid.Column="1" Text="0-59的整数"/>
            <SelectableTextBlock Grid.Row="2" Grid.Column="0" Text="时" FontWeight="SemiBold"/>
            <SelectableTextBlock Grid.Row="2" Grid.Column="1" Text="0-23的整数"/>
            <SelectableTextBlock Grid.Row="3" Grid.Column="0" Text="日" FontWeight="SemiBold"/>
            <SelectableTextBlock Grid.Row="3" Grid.Column="1" Text="1-31的整数（需要考虑月份）"/>
            <SelectableTextBlock Grid.Row="4" Grid.Column="0" Text="月" FontWeight="SemiBold"/>
            <SelectableTextBlock Grid.Row="4" Grid.Column="1" Text="1-12的整数或JAN-DEC"/>
            <SelectableTextBlock Grid.Row="5" Grid.Column="0" Text="周" FontWeight="SemiBold"/>
            <SelectableTextBlock Grid.Row="5" Grid.Column="1" Text="1-7的整数或SUN-SAT（1=SUN）"/>
          </Grid>
          
          <SelectableTextBlock Text="特殊字符" FontWeight="SemiBold" Margin="0,10,0,0"/>
          <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" 
                ColumnDefinitions="40,*" 
                Margin="10,0">
            <SelectableTextBlock Grid.Row="0" Grid.Column="0" Text="*" FontWeight="SemiBold" FontFamily="Consolas"/>
            <SelectableTextBlock Grid.Row="0" Grid.Column="1" Text="匹配任意值"/>
            <SelectableTextBlock Grid.Row="1" Grid.Column="0" Text="?" FontWeight="SemiBold" FontFamily="Consolas"/>
            <SelectableTextBlock Grid.Row="1" Grid.Column="1" Text="不指定值（仅用于日和周）"/>
            <SelectableTextBlock Grid.Row="2" Grid.Column="0" Text="-" FontWeight="SemiBold" FontFamily="Consolas"/>
            <SelectableTextBlock Grid.Row="2" Grid.Column="1" Text="范围，如1-5表示1到5"/>
            <SelectableTextBlock Grid.Row="3" Grid.Column="0" Text="," FontWeight="SemiBold" FontFamily="Consolas"/>
            <SelectableTextBlock Grid.Row="3" Grid.Column="1" Text="列举，如1,3,5表示135"/>
            <SelectableTextBlock Grid.Row="4" Grid.Column="0" Text="/" FontWeight="SemiBold" FontFamily="Consolas"/>
            <SelectableTextBlock Grid.Row="4" Grid.Column="1" Text="步长，如*/5表示每5个单位"/>
            <SelectableTextBlock Grid.Row="5" Grid.Column="0" Text="L" FontWeight="SemiBold" FontFamily="Consolas"/>
            <SelectableTextBlock Grid.Row="5" Grid.Column="1" Text="最后，如L表示月的最后一天"/>
          </Grid>
          
          <SelectableTextBlock Text="示例" FontWeight="SemiBold" Margin="0,10,0,0"/>
          <StackPanel Spacing="4" Margin="10,0">
            <SelectableTextBlock Text="• 0 0 12 * * ? - 每天中午12点执行"/>
            <SelectableTextBlock Text="• 0 */15 * * * ? - 每15分钟执行一次"/>
            <SelectableTextBlock Text="• 0 0 9 ? * MON-FRI - 工作日上午9点执行"/>
            <SelectableTextBlock Text="• 0 0 0 1 * ? - 每月1号午夜执行"/>
            <SelectableTextBlock Text="• 0 0 0 L * ? - 每月最后一天午夜执行"/>
          </StackPanel>
        </StackPanel>
      </Expander>
    </StackPanel>
  </ScrollViewer>
</UserControl>

